import { LoginHeader } from "@/components/headers/loginHeader";
import { Text } from "@/components/PoppinsText";
import { useAuth } from "@/context/AuthContext";
import { useRouter } from "expo-router";
import { Check, Eye, EyeOff, Lock, User } from "lucide-react-native";
import { useState } from "react";
import {
  Alert,
  KeyboardAvoidingView,
  Platform,
  TextInput,
  TouchableOpacity,
  View,
} from "react-native";

export default function FirstAccessScreen() {
  const [isShowingPassword, setIsShowingPassword] = useState(false);
  const [cpf, setCpf] = useState("");
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const { firstAccess, isLoading } = useAuth();
  const router = useRouter();

  async function handleFirstAccess() {
    try {
      if (!cpf || !password || !confirmPassword) {
        Alert.alert("Erro", "Preencha todos os campos");
        return;
      }
      if (password !== confirmPassword) {
        Alert.alert("Erro", "As senhas não coincidem");
        return;
      }

      await firstAccess(cpf, password, confirmPassword);

      Alert.alert(
        "Sucesso",
        "Senha criada com sucesso! Faça login para continuar.",
      );
      router.back();
    } catch (error: any) {
      Alert.alert("Erro", error.message);
    }
  }

  return (
    <View className="h-full w-full bg-white gap-4 flex flex-col">
      <LoginHeader />
      <KeyboardAvoidingView
        behavior={Platform.OS === "ios" ? "padding" : "height"}
        className="w-full px-4 flex flex-col"
      >
        <View className="flex flex-col gap-8 items-start w-full">
          <View className="w-full flex flex-wrap flex-row items-center justify-center">
            <Text className="text-primary-500 text-2xl font-poppins-semi-bold text-center">
              Primeiro Acesso
            </Text>
            <Text className="text-secondary-400 text-sm font-poppins-regular text-center mt-2">
              Confirme seu CPF e crie uma senha segura.
            </Text>
          </View>

          <View className="flex flex-col gap-1 w-full">
            <Text className="text-secondary-400 font-poppins-bold">CPF</Text>
            <View className="flex flex-row gap-2 w-full items-center border-[#a3a3a3] border-b">
              <User color={"#ED6842"} />
              <TextInput
                placeholderTextColor={"#a3a3a3"}
                placeholder="Insira o seu CPF"
                className="flex-1 h-12"
                autoCapitalize="none"
                keyboardType="numeric"
                value={cpf}
                onChangeText={setCpf}
              />
            </View>
          </View>

          <View className="flex flex-col gap-1 w-full">
            <Text className="text-secondary-400  font-poppins-bold">
              Nova Senha
            </Text>
            <View className="flex flex-row gap-2 w-full items-center border-[#a3a3a3] border-b">
              <Lock color={"#ED6842"} />
              <TextInput
                placeholderTextColor={"#a3a3a3"}
                placeholder="Crie uma senha"
                className="flex-1 h-12"
                secureTextEntry={!isShowingPassword}
                value={password}
                onChangeText={setPassword}
              />
              <TouchableOpacity
                onPress={() => setIsShowingPassword(!isShowingPassword)}
              >
                {isShowingPassword ? (
                  <EyeOff color={"#a3a3a3"} />
                ) : (
                  <Eye color={"#a3a3a3"} />
                )}
              </TouchableOpacity>
            </View>
          </View>

          <View className="flex flex-col gap-1 w-full">
            <Text className="text-secondary-400  font-poppins-bold">
              Confirmar Senha
            </Text>
            <View className="flex flex-row gap-2 w-full items-center border-[#a3a3a3] border-b">
              <Check color={"#ED6842"} />
              <TextInput
                placeholderTextColor={"#a3a3a3"}
                placeholder="Confirme a senha"
                className="flex-1 h-12"
                secureTextEntry={!isShowingPassword}
                value={confirmPassword}
                onChangeText={setConfirmPassword}
              />
            </View>
          </View>
        </View>
      </KeyboardAvoidingView>
      <View className="w-full flex flex-col flex-1 p-4 py-8 justify-between">
        <TouchableOpacity
          onPress={handleFirstAccess}
          disabled={isLoading}
          className={`bg-secondary-500  flex items-center justify-center w-full rounded-xl py-4 ${
            isLoading ? "opacity-50" : ""
          }`}
        >
          <Text className="text-white text-xl font-poppins-bold text-center">
            CRIAR SENHA
          </Text>
        </TouchableOpacity>
        <TouchableOpacity onPress={() => router.back()} className="mt-4">
          <Text className="text-secondary-500 text-base font-poppins-regular text-center">
            Voltar para Login
          </Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}
